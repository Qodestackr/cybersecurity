# Malware Analysis: Windows Internals

### Win32 API

The Windows OS allows developers to invoke low-level API commonly referred to as the Win32 API. The Win32 APIs provide an interface to the
Windows OS for developers who wish to write software that'll run on the Windows OS. The Windows APIs are available for both 32-bit and 64-bit
Windows OS. Malware developed to run on a Windows OS will invoke a ton of Windows API functions so a malware analyst must be familiar with
the APIs commonly used by malware in order to distinguish malicious API usage from ordinary usage. This requires that a malware analyst
observes the context in which an API is being utilized in and not just that the API was used, otherwise, all applications running on a 
Windows OS would be considered malicious. 

**API Logs**

Using static analysis techniques, one can view the Win32 APIs that a PE file is using by viewing the Import Table. Disassemblying a PE file can also inform us of the APIs the PE file is calling. Although, we can view the APIs used by a PE file statically, we ideally want to observe how these APIs are being used dynamically, meaning we should run the PE file and observe the context in which the PE file invokes these APIs.

**Win32 DLLs**

Win32 APIs are defined within hundreds of DLL files located in the `C:\Windows\system32` directory. One DLL file located here is called `kernel32.dll` and it contains APIs that are used by many Windows applications, both benign and malicious. Other Windows DLLs that are also commonyly used by malware authors are:

```
ntdll.dll
kernelbase.dll
advapi.dll
netapi32.dll
user32.dll
ole32.dll
wininet.dll
```

There are also DLLs provided by common Software Development Kits (for example Visual Studios SDK) that are constantly being utilized by malware.


**Learning about Win32 APIs using Microsofts's Developer Network**

Learning about an API is as simple as using a search engine to search for the name of the API you would like to know more about, and looking for the link that matches, `docs.microsoft.com` and contains the name of the target API. Clicking on the link will take you to the documentation for the API you queried for. The documentation will contain an explanation of what the API does and an explanation for each of the arguments, if any, that are required for invoking the API correctly. The arguments for an API can be regular Win32 data types ([Win32 Data Types](https://docs.microsoft.com/en-us/windows/win32/winprog/windows-data-types)) or they can be more complex types like pointers to structs. The arguments for an API will determine ultimately determine the functionality of the API. Each argument may have several potential values that will alter the APIs behavior. 

APIs that have string arguments will exist in two variants that can be distinguished by the character suffic "A" or "W". For example, the `CreateFile`  API has two variants because it requires a string argument (`lpFileName`), one of them is  `CreateFileA` for invoking the API with ASCII strings and the other is  `CreateFileW` for invoking the API with Unicode wide strings.

**NT APIs**

The `ntdll.dll` file contains very low-level APIs called NT APIs, which are normally never directly invoked by an application, but are instead accessed via wrapper APIs. For example, the `CreateFileA` and `CreateFileW` APIs are defined in the  `kernel32.dll` file and they are wrappers for the low-level native API , `NTCreateFile`, which exists in the `ntdll.dll` file.

**Extended API Versions**

Some APIs may also have extended versions of themselves. Extended versions of APIs contain the suffix "Ex". A very common API used by malware that has an extended version is `VirtualAlloc`. The extended version therefore for `VirtualAlloc` is `VirtualAllocEx`. The extended version normally offers more functionality then the normal version. For example, the normal version of `VirtualAlloc` only allows allocation of memory in the current process. On the contrary, the extended version allows for the allocation of memory not only in the current process, but also in remote processes. (`VirtualAllocEx` is commonly used for Process Injection, check out a Python script I wrote for performing Process Injection [here](https://github.com/binexisHATT/EthicalHacking/blob/master/AntivirusEvasion/RemoteProcessAttacks/ShellCodeInject/Python/process_injector.py).

**WIN32 API To Memorize**

- file operation APIs:
  1. CreateFile
  2. WriteFile
  3. ReadFile
  4. SetFilePointer
  5. DeleteFile
  6. CloseFile
- Windows Registry APIs:
  1. RegCreateKey
  2. RegDeleteKey
  3. RegSetValue
- virtual memory APIs:
  1. VirtualAlloc
  2. VirtualProtect
  3. NtCreateSection
  4. WriteProcessMemory
  5. NtMapViewOfSection
- processes and threads APIs:
  1. CreateProcess
  2. ExitProcess
  3. CreateRemoteThread
  4. CreateThread
  5. GetThreadContext
  6. SetThreadContext
  7. TerminateProcess
  8. CreateProcessInternalW
- DLL APIs:
  1. LoadLibrary
  2. GetProcAddress
- Windows services APIs:
  1. OpenSCManager
  2. CreateService
  3. OpenService
  4. ChangeServiceConfig2W
  5. StartService
- mutex APIs:
  1. CreateMutex
  2. OpenMutex

** Malware Identification Using Handles **

Every thing in Windows is an object and to manipulate an object, we need to establish a "Handle" to the object. I like to think of a handle as simply a pointer to an object. Handles are passed as arguments to Win32 APIs, allowing the API to know what object it is manipulating. Handles can be used to identify malware by observing sequences of APIs that act against a shared handle. Following the sequence of APIs against the same handle provides context that can be analyzed to determine is the API calls are malicious.
